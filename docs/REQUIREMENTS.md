# WEB3D 赛车游戏 - 需求文档

**版本**: 2.0  
**最后更新**: 2025-01-24  
**状态**: 活跃开发中

## ?? 文档目录

- [项目概述](#项目概述)
- [需求分析](#需求分析)
- [功能需求](#功能需求)
- [非功能需求](#非功能需求)
- [技术需求](#技术需求)
- [需求优先级](#需求优先级)
- [需求变更历史](#需求变更历史)

---

## 项目概述

### 项目愿景

开发一款在Web浏览器中运行的3D赛车游戏，灵感来自《极品飞车2》（Need For Speed II），提供流畅的驾驶体验、真实的物理模拟和丰富的游戏内容。

### 项目目标

1. **技术目标**
   - 在Web平台实现60FPS的3D赛车游戏
   - 支持现代浏览器（Chrome、Firefox、Edge、Safari）
   - 利用WebGPU加速（可选WebGL回退）
   - 模块化、可维护的代码架构

2. **游戏目标**
   - 提供多样化的车辆选择（至少5种类型）
   - 实现真实的车辆物理和驾驶感受
   - 设计有趣的赛道和环境
   - 支持单人竞速和计时挑战

3. **用户体验目标**
   - 快速加载（< 5秒首屏）
   - 流畅操作（60 FPS稳定）
   - 直观的UI/UX
   - 移动端适配（可选）

### 参考项目

- **Need For Speed II (1997)** - 游戏玩法和风格参考
  - GitHub: https://github.com/zaps166/NFSIISE
  - 关键特性：多样车辆、真实物理、精美环境

### 目标用户

- **主要用户**: PC端赛车游戏爱好者
- **次要用户**: Web技术开发者、3D图形学习者
- **年龄层**: 16-35岁
- **技能水平**: 休闲玩家到硬核玩家

---

## 需求分析

### 业务需求 (Business Requirements)

#### BR-001: 市场定位
**优先级**: P0  
**描述**: 作为一款Web赛车游戏，填补浏览器3D赛车游戏的空白  
**验收标准**:
- 游戏可在主流浏览器运行
- 不需要安装任何插件或扩展
- 提供Demo可供试玩

#### BR-002: 技术展示
**优先级**: P1  
**描述**: 展示现代Web技术（WebGPU、WebAssembly）的能力  
**验收标准**:
- 使用WebGPU进行GPU加速
- 集成WASM物理引擎（Rapier）
- 达到原生应用级别的性能

#### BR-003: 开源生态
**优先级**: P2  
**描述**: 作为开源项目，供社区学习和贡献  
**验收标准**:
- 代码开源在GitHub
- 提供完整文档
- 接受社区PR

---

## 功能需求

### 1. 核心游戏功能

#### FR-001: 车辆系统
**优先级**: P0  
**状态**: ? 已完成（90%）  
**负责人**: Vehicle Team

**子需求**:

##### FR-001.1: 车辆配置系统
- **描述**: 支持通过JSON配置车辆参数
- **验收标准**:
  - ? 每个车辆有独立配置文件
  - ? 支持物理参数（质量、轮半径等）
  - ? 支持性能参数（加速、制动、转向等）
  - ? 支持视觉参数（颜色、模型路径等）
- **实现状态**: 已完成
  - `src/core/VehicleConfig.ts` - 类型定义
  - `assets/vehicles/*.json` - 配置文件

##### FR-001.2: 车辆选择系统
- **描述**: 游戏开始前选择车辆
- **验收标准**:
  - ? 显示所有可用车辆
  - ? 显示车辆统计和详情
  - ? 支持类别筛选
  - ? 解锁/锁定机制
- **实现状态**: 已完成
  - `src/core/VehicleManager.ts` - 管理器
  - `src/ui/VehicleSelectionUI.ts` - 选择界面

##### FR-001.3: 车辆物理模拟
- **描述**: 真实的车辆物理行为
- **验收标准**:
  - ? Fast模式（简化物理，高性能）
  - ? Precise模式（精确物理，真实感）
  - ? 支持碰撞检测
  - ? 支持损伤系统
- **实现状态**: 部分完成
  - `src/gameplay/VehicleControllerFast.ts` - 快速模式
  - `src/gameplay/VehicleControllerPrecise.ts` - 精确模式
  - 待实现：碰撞和损伤

##### FR-001.4: 车辆控制
- **描述**: 响应式的车辆控制
- **验收标准**:
  - ? 键盘控制（WASD/方向键）
  - ? 手柄支持（Gamepad API）
  - ? 移动端触摸控制
  - ? 可配置灵敏度
- **实现状态**: 部分完成
  - `src/core/InputManager.ts` - 输入系统
  - 待实现：手柄和触摸

##### FR-001.5: 车辆动画系统
- **描述**: 车辆动画驱动
- **验收标准**:
  - ? 轮胎旋转动画
  - ? 方向盘转向动画
  - ? 悬挂压缩动画
  - ? 引擎动画（如有）
- **实现状态**: 待实现
  - 已设计：`docs/vehicle_design.md`
  - 代码框架：`src/gameplay/AnimationController.ts`

##### FR-001.6: 车辆音效系统
- **描述**: 车辆音效反馈
- **验收标准**:
  - ? 引擎声音（随RPM变化）
  - ? 轮胎声音（漂移、刹车）
  - ? 碰撞声音
  - ? 环境音效
- **实现状态**: 待实现
  - 已规划：配置中包含音频路径

---

#### FR-002: 道路系统
**优先级**: P0  
**状态**: ? 已完成（85%）  
**负责人**: Road Team

**子需求**:

##### FR-002.1: 道路生成
- **描述**: 动态生成道路网格
- **验收标准**:
  - ? 样条曲线道路
  - ? 可配置宽度、段数
  - ? 支持倾斜角（banking）
  - ? 纹理映射
- **实现状态**: 已完成
  - `src/world/RoadManager.ts`

##### FR-002.2: 赛道预设
- **描述**: 预定义赛道配置
- **验收标准**:
  - ? JSON格式赛道文件
  - ? 控制点定义
  - ? 场景对象关联
  - ? 起始位置设置
- **实现状态**: 已完成
  - `assets/tracks/*.json`
  - `src/world/RoadPresets.ts`

##### FR-002.3: 道路渲染优化
- **描述**: 高性能道路渲染
- **验收标准**:
  - ? LOD（细节层次）
  - ? 视锥剔除
  - ? 纹理流式加载
  - ? 实例化渲染
- **实现状态**: 部分完成
  - 待优化：纹理流式加载

---

#### FR-003: 环境系统
**优先级**: P1  
**状态**: ? 已完成（75%）  
**负责人**: Environment Team

**子需求**:

##### FR-003.1: 路边对象生成
- **描述**: 自动生成路边环境对象
- **验收标准**:
  - ? 树木、建筑、岩石等
  - ? 基于道路曲线分布
  - ? 随机变化（位置、旋转、缩放）
  - ? 密度控制
- **实现状态**: 已完成
  - `src/world/RoadsideSpawner.ts`
  - `src/world/SpawnerUtils.ts`

##### FR-003.2: GPU加速剔除
- **描述**: 使用GPU进行视锥剔除
- **验收标准**:
  - ? WebGPU实现
  - ? WebGL回退方案
  - ? Worker线程支持
  - ? 性能指标（>10x提升）
- **实现状态**: 已完成
  - `src/world/WebGpuCuller.ts`
  - `src/world/GpuCuller.ts`
  - `public/gpu_culler_worker.js`

##### FR-003.3: 实例化渲染
- **描述**: 高效渲染大量相同对象
- **验收标准**:
  - ? InstancedMesh支持
  - ? 动态更新
  - ? Impostor渲染（远距离）
  - ? 纹理图集
- **实现状态**: 已完成
  - `src/world/InstanceRenderer.ts`
  - `assets/atlases/atlas_list.json`

##### FR-003.4: 烘焙场景
- **描述**: 预烘焙场景提高性能
- **验收标准**:
  - ? 场景导出工具
  - ? JSON格式存储
  - ? 快速加载
  - ? 编辑器支持
- **实现状态**: 部分完成
  - `src/world/BakedExporter.ts`
  - 待实现：编辑器

##### FR-003.5: 天气系统
- **描述**: 动态天气效果
- **验收标准**:
  - ? 晴天、雨天、雾天
  - ? 实时天气变化
  - ? 影响物理（湿滑路面）
  - ? 视觉效果（雨滴、雾气）
- **实现状态**: 待实现

##### FR-003.6: 昼夜循环
- **描述**: 时间变化和光照
- **验收标准**:
  - ? 动态光照方向
  - ? 天空盒变化
  - ? 车灯自动开启
  - ? 阴影实时更新
- **实现状态**: 待实现

---

#### FR-004: 物理系统
**优先级**: P0  
**状态**: ? 已完成（80%）  
**负责人**: Physics Team

**子需求**:

##### FR-004.1: 双物理后端
- **描述**: 支持两种物理引擎
- **验收标准**:
  - ? Rapier引擎（精确）
  - ? Fake引擎（快速）
  - ? 运行时切换
  - ? 统一API
- **实现状态**: 已完成
  - `src/gameplay/RapierPhysicsWorld.ts`
  - `src/gameplay/FakePhysicsWorld.ts`
  - `src/core/modules/PhysicsModule.ts`

##### FR-004.2: 碰撞检测
- **描述**: 车辆与环境碰撞
- **验收标准**:
  - ? 车辆-道路边界
  - ? 车辆-环境对象
  - ? 车辆-车辆（多人）
  - ? 触发器（检查点）
- **实现状态**: 待实现

##### FR-004.3: 物理材质
- **描述**: 不同表面的物理属性
- **验收标准**:
  - ? 沥青、泥土、草地
  - ? 摩擦系数
  - ? 反弹系数
  - ? 阻尼系数
- **实现状态**: 待实现

---

#### FR-005: 渲染系统
**优先级**: P0  
**状态**: ? 已完成（90%）  
**负责人**: Render Team

**子需求**:

##### FR-005.1: 核心渲染
- **描述**: Three.js渲染管线
- **验收标准**:
  - ? WebGL2渲染器
  - ? 自适应分辨率
  - ? 后处理效果
- ? 阴影贴图
- **实现状态**: 已完成
  - `src/core/modules/RenderModule.ts`

##### FR-005.2: 纹理系统
- **描述**: 纹理管理和生成
- **验收标准**:
  - ? 程序化纹理生成
  - ? 文件纹理加载
  - ? 纹理图集
  - ? 压缩纹理支持
- **实现状态**: 已完成
  - `src/core/modules/TextureModule.ts`
  - `tools/generate_textures.js`

##### FR-005.3: WebGPU支持
- **描述**: WebGPU渲染后端
- **验收标准**:
  - ? 自动检测支持
  - ? Compute shader
  - ? 完整渲染管线
  - ? WebGL回退
- **实现状态**: 部分完成
  - 完成：Compute shader culling
  - 待实现：完整渲染管线

##### FR-005.4: 特效系统
- **描述**: 视觉特效
- **验收标准**:
  - ? 粒子系统（烟雾、尘土）
  - ? 拖影效果（速度线）
  - ? Bloom光晕
  - ? 运动模糊
- **实现状态**: 待实现

---

#### FR-006: UI系统
**优先级**: P0  
**状态**: ? 已完成（70%）  
**负责人**: UI Team

**子需求**:

##### FR-006.1: 游戏内HUD
- **描述**: 实时游戏信息显示
- **验收标准**:
  - ? 速度表
  - ? 计时器
  - ? 小地图
  - ? 排名/位置
- **实现状态**: 部分完成
  - `src/core/modules/UIModule.ts`

##### FR-006.2: 主菜单
- **描述**: 游戏启动菜单
- **验收标准**:
  - ? 开始游戏
  - ? 车辆选择
  - ? 赛道选择
  - ? 设置选项
- **实现状态**: 部分实现
  - ? 车辆选择界面
  - 待实现：完整主菜单

##### FR-006.3: 暂停菜单
- **描述**: 游戏暂停界面
- **验收标准**:
  - ? 继续游戏
  - ? 重新开始
  - ? 返回主菜单
  - ? 设置
- **实现状态**: 部分完成

##### FR-006.4: 结果界面
- **描述**: 比赛结束统计
- **验收标准**:
  - ? 成绩时间
  - ? 最佳圈速
  - ? 排名
  - ? 奖励/解锁
- **实现状态**: 待实现

---

#### FR-007: 音频系统
**优先级**: P2  
**状态**: ? 待实现（0%）

**子需求**:
- 背景音乐播放
- 环境音效
- 车辆音效（引擎、轮胎等）
- 音量控制
- 3D空间音频

---

#### FR-008: 游戏模式
**优先级**: P1  
**状态**: ? 部分实现（30%）

**子需求**:

##### FR-008.1: 自由驾驶模式
- **描述**: 无限制探索赛道
- **状态**: ? 已实现

##### FR-008.2: 计时赛模式
- **描述**: 单人计时挑战
- **状态**: ? 待实现

##### FR-008.3: 竞速模式
- **描述**: 与AI对战
- **状态**: ? 待实现

##### FR-008.4: 多人模式
- **描述**: 在线多人竞速
- **状态**: ? 待规划

---

#### FR-009: 进度系统
**优先级**: P2  
**状态**: ? 待实现（0%）

**子需求**:
- 玩家账户系统
- 车辆解锁系统
- 成就系统
- 排行榜
- 数据持久化（LocalStorage/云端）

---

#### FR-010: 关卡编辑器
**优先级**: P3  
**状态**: ? 待规划（0%）

**子需求**:
- 可视化赛道编辑
- 环境对象放置
- 起点/终点设置
- 导出/导入功能
- 实时预览

---

### 2. 非功能需求

#### NFR-001: 性能要求
**优先级**: P0

| 指标 | 目标值 | 当前值 | 状态 |
|------|--------|--------|------|
| 帧率 | ≥60 FPS | 60 FPS | ? |
| 初始化时间 | <3s | ~0.82s | ? |
| 内存占用 | <200MB | ~125MB | ? |
| 包体积(gzip) | <500KB | ~68KB | ? |
| 首屏加载 | <5s | ~2s | ? |

#### NFR-002: 兼容性要求
**优先级**: P0

| 浏览器 | 最低版本 | WebGL | WebGPU | 状态 |
|--------|----------|-------|---------|------|
| Chrome | 90+ | ? | ? | ? |
| Firefox | 88+ | ? | ? | ? |
| Edge | 90+ | ? | ? | ? |
| Safari | 14+ | ? | ? | ? |

#### NFR-003: 可维护性要求
**优先级**: P0

- ? 模块化架构（9个独立模块）
- ? TypeScript类型安全
- ? 单元测试覆盖率 >70%
- ? API文档完整
- ? 代码注释充分

#### NFR-004: 可扩展性要求
**优先级**: P1

- ? 支持添加新车辆（JSON配置）
- ? 支持添加新赛道（JSON配置）
- ? 支持添加新物理后端
- ? 支持添加新游戏模式
- ? 插件系统

#### NFR-005: 安全性要求
**优先级**: P2

- ? 输入验证
- ? XSS防护
- ? 作弊检测（多人模式）
- ? 数据加密（用户数据）

---

### 3. 技术需求

#### TR-001: 技术栈
**必须使用**:
- ? TypeScript 5.x
- ? Three.js r150+
- ? Rapier.js 0.11+
- ? Vite 4.x
- ? Vitest 测试框架

**可选使用**:
- WebGPU API
- Web Workers
- WebAssembly

#### TR-002: 代码质量
- ? ESLint规则遵守
- ? Prettier格式化
- ? 无TypeScript错误
- ? 测试通过率100%

#### TR-003: 文档要求
- ? README.md完整
- ? API文档（JSDoc）
- ? 架构设计文档
- ? 使用指南
- ? 贡献者指南

---

## 需求优先级

### P0 - 关键需求（必须完成）
1. ? 车辆系统基础功能
2. ? 道路生成和渲染
3. ? 物理引擎集成
4. ? 基础UI/HUD
5. ? 输入控制
6. ? 渲染优化

### P1 - 重要需求（强烈建议）
1. ? 环境系统（GPU culling）
2. ? 车辆选择系统
3. ? 计时赛模式
4. ? 音效系统基础
5. ? 完整UI流程

### P2 - 期望需求（时间允许）
1. ? 进度系统
2. ? 成就系统
3. ? 天气系统
4. ? AI对手
5. ? 多种游戏模式

### P3 - 锦上添花（未来版本）
1. ? 关卡编辑器
2. ? 多人联机
3. ? VR支持
4. ? 移动端优化
5. ? 插件系统

---

## 需求变更历史

### v2.0 (2025-01-24)
**变更类型**: 重大重构

**新增需求**:
- FR-001.2: 车辆选择系统
- FR-003.2: GPU加速剔除
- FR-004.1: 双物理后端支持
- FR-005.2: 纹理系统重构

**修改需求**:
- FR-001.3: 拆分为Fast/Precise两种模式
- FR-003.1: 增强路边对象生成能力
- FR-005.1: 模块化渲染系统

**删除需求**:
- ~~单一物理引擎设计~~ → 改为双后端

**影响分析**:
- ? 架构更清晰，易维护
- ? 性能显著提升
- ? 扩展性增强
- ?? 代码量增加约30%

### v1.5 (2024-12)
**变更类型**: 功能增强

**新增需求**:
- 环境系统设计
- 烘焙场景支持
- 实例化渲染

### v1.0 (2024-11)
**变更类型**: 初始需求

**初始需求集**:
- 基础车辆系统
- 简单道路生成
- 基础物理模拟
- 简单渲染

---

## 需求验证矩阵

| 需求ID | 需求名称 | 测试用例 | 验收状态 |
|--------|----------|----------|----------|
| FR-001.1 | 车辆配置系统 | `vehicle_config.test.ts` | ? 通过 |
| FR-001.2 | 车辆选择系统 | 手动测试 | ? 通过 |
| FR-001.3 | 车辆物理模拟 | `vehicle_fast.test.ts`, `vehicle_rapier_sync.test.ts` | ? 通过 |
| FR-002.1 | 道路生成 | `road_manager.test.ts` | ? 通过 |
| FR-003.1 | 路边对象生成 | `spawner.test.ts` | ? 通过 |
| FR-003.2 | GPU加速剔除 | `gpu_culling_demo.html` | ? 通过 |
| FR-003.3 | 实例化渲染 | `instanceRenderer.test.ts` | ? 通过 |
| FR-004.1 | 双物理后端 | `physics_lifecycle.test.ts` | ? 通过 |
| FR-005.1 | 核心渲染 | 集成测试 | ? 通过 |
| FR-005.2 | 纹理系统 | 手动验证 | ? 通过 |
| FR-006.1 | 游戏内HUD | 手动测试 | ? 通过 |

---

## 需求追踪

### 需求来源
- **产品愿景**: 创建Web平台最佳赛车游戏
- **技术调研**: WebGPU、Rapier性能测试
- **用户反馈**: (待收集)
- **竞品分析**: NFS II、Web赛车游戏

### 需求责任人
- **产品负责人**: @doeasier
- **技术负责人**: @doeasier
- **测试负责人**: @doeasier

### 需求评审
- **上次评审**: 2025-01-24
- **下次评审**: 2025-02-15
- **评审周期**: 每月一次

---

## 附录

### 术语表
- **GPU Culling**: 使用GPU进行视锥剔除
- **Impostor**: 远距离对象的简化渲染技术
- **WebGPU**: 新一代Web图形API
- **Rapier**: 物理引擎库
- **LOD**: Level of Detail，细节层次

### 参考资料
- [Need For Speed II 源码](https://github.com/zaps166/NFSIISE)
- [Three.js 文档](https://threejs.org/docs/)
- [Rapier.js 文档](https://rapier.rs/docs/)
- [WebGPU 规范](https://www.w3.org/TR/webgpu/)

---

**文档维护者**: GitHub Copilot + Development Team  
**最后审核**: 2025-01-24  
**下次更新**: 需求变更时或每月评审后
